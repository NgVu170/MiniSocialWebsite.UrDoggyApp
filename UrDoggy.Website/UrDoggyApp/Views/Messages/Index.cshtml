@using UrDoggy.Core.Models
@using System.Collections
@using System.Linq

@inject UrDoggy.Services.Interfaces.IUserService UserService

@{
    Layout = "_Layout";
    int me = Context.Session.GetInt32("UserId") ?? 0;
    var chats = ((IEnumerable)ViewBag.Chats).Cast<ConversationDto>().ToList();
    int activeId = (int)ViewBag.ActiveUser;
    var thread = (List<Message>)ViewBag.Thread;
    var partner = chats.FirstOrDefault(c => c.OtherId == activeId);
    var defaultAvatar = Url.Content("~/images/default-avatar.png");
}

<style>
    /* Message System Style */
    :root {
        --msg-primary: #25D366;
        --msg-secondary: #0984e3;
        --msg-bg: #f5f7fa;
        --msg-card: #ffffff;
        --msg-border: rgba(0, 0, 0, 0.1);
        /* Adjusted height assumption for cleaner layout. You may need to fine-tune `120px` */
        --layout-offset: 120px;
        --chat-height: calc(100vh - var(--layout-offset));
    }

    /* Chats List Styles (Retained) */
    .list-group-item {
        border: none;
        border-radius: 1.5rem !important;
        margin-bottom: 0.5rem;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        background: var(--msg-card);
    }

        .list-group-item.active {
            background: linear-gradient(135deg, var(--msg-primary) 0%, var(--msg-secondary) 100%) !important;
            color: white !important;
            box-shadow: 0 4px 12px rgba(37, 211, 102, 0.2);
        }

        .list-group-item:not(.active):hover {
            transform: translateX(8px);
            background: rgba(37, 211, 102, 0.05);
        }

    /* Main Chat Area Styles */
    .chat-container-wrapper {
        display: flex;
        flex-direction: column;
        height: var(--chat-height);
        background: var(--msg-bg);
        border-radius: 1.5rem;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.05);
        padding: 0;
    }

    .message-thread {
        flex-grow: 1;
        overflow-y: auto;
        padding: 1rem;
        /* Increased padding to prevent messages hiding behind the fixed input box */
        padding-bottom: 7rem;
    }

    /* Fixed Send Box CSS */
    /* This calculation depends on your full layout. If the chat area is a fixed column (e.g., col-8) */
    /* Adjust these to match the width of the main content column where the chat lives. */
    .send-box-fixed {
        background: var(--msg-card);
        padding: 1rem;
        border-radius: 1.5rem;
        box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.05);
        position: fixed;
        /* Position to cover the bottom area of the main content column */
        bottom: 1rem;
        left: 50%; /* Default center alignment */
        transform: translateX(-50%);
        width: calc(100% - 30px);
        max-width: 900px;
        z-index: 1000;
    }

    @@media (min-width: 992px) {
        .send-box-fixed {
            /* This assumes the main content area is centered or properly sized */
            /* You must adjust '66%' based on your column setup (e.g., if chat is col-8, this is ~66%) */
            width: 65vw;
            left: 50%;
            transform: translateX(-50%);
        }
    }


    /* Message Bubble Styles (Retained/Refined) */
    .message-bubble {
        max-width: 75%;
        padding: 0.75rem 1rem;
        border-radius: 1.25rem;
        word-break: break-word;
    }

        .message-bubble.mine {
            background: linear-gradient(135deg, var(--msg-primary) 0%, var(--msg-secondary) 100%);
            color: white;
            border-bottom-right-radius: 0.5rem;
        }

        .message-bubble.other {
            background: var(--msg-card);
            color: #34495e;
            border: 1px solid var(--msg-border);
            border-bottom-left-radius: 0.5rem;
        }

    .message-actions {
        visibility: hidden;
        opacity: 0;
        transition: visibility 0s, opacity 0.2s linear;
        margin: 0 0.5rem;
        align-self: center;
    }

    .d-flex:hover .message-actions {
        visibility: visible;
        opacity: 1;
    }

    .chat-header {
        padding: 1rem;
        background: white;
        border-bottom: 1px solid var(--msg-border);
        border-top-left-radius: 1.5rem;
        border-top-right-radius: 1.5rem;
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .spinner-border-sm {
        width: 1rem;
        height: 1rem;
        border-width: 0.15em;
    }

    ::-webkit-scrollbar {
        display: none;
    }
</style>


@* --- Left Sidebar (Chat List) --- *@
@section LeftSidebar {
    <div class="px-2 pt-3">
        <h6 class="px-1 fw-bold text-secondary text-uppercase mb-3">Chats</h6>
        <ul class="list-group list-group-flush">
            @foreach (var c in chats)
            {
                // ... (List item rendering logic retained) ...
                bool isActive = c.OtherId == activeId;
                var user = await UserService.GetById(c.OtherId);
                string avatarUrl = string.IsNullOrWhiteSpace(user?.ProfilePicture)
                ? defaultAvatar
                : Url.Content(user.ProfilePicture);

                <li class="list-group-item p-0 mb-2 @(isActive ? "active" : "")">
                    <a href="@Url.Action("Index","Messages", new { otherUserId = c.OtherId })"
                       class="d-flex align-items-center text-reset text-decoration-none p-3">
                        <div class="avatar-status me-3">
                            <img src="@avatarUrl" class="rounded-circle" alt="@c.OtherUsername" style="width:48px;height:48px;" />
                        </div>
                        <div class="flex-grow-1">
                            <div class="fw-bold @(isActive ? "text-white" : "text-dark")">@c.OtherUsername</div>
                            <div class="small text-truncate @(isActive ? "text-white-50" : "text-muted")" style="max-width:100%">
                                @if (String.IsNullOrEmpty(c.Preview))
                                {
                                    <em class="@(isActive ? "text-white-50" : "text-muted")">No messages yet</em>
                                }
                                else
                                {
                                    <strong>@(c.PreviewSenderId == me ? "You: " : "")</strong>
                                    @c.Preview
                                }
                            </div>
                        </div>
                        <div class="small text-muted text-end ms-2 @(isActive ? "text-white-50" : "")">
                            @(!String.IsNullOrEmpty(c.Preview) ? c.Time.ToString("t") : "")
                        </div>
                    </a>
                </li>
            }
        </ul>
    </div>
}

@* --- Right Sidebar (Partner Info) --- *@
@section RightSidebar {
    @if (partner != null)
    {
        var user = await UserService.GetById(partner.OtherId);
        string avatarUrl = string.IsNullOrWhiteSpace(user?.ProfilePicture)
        ? defaultAvatar
        : Url.Content(user.ProfilePicture);

        <div class="border rounded bg-white p-4 text-center  mt-3" style="top: 1rem;">
            <img src="@avatarUrl" class="rounded-circle mb-3" alt="@partner.OtherUsername" style="width:80px;height:80px;" />
            <h5 class="fw-bold mb-1">@partner.OtherUsername</h5>
            <span class="badge bg-success mb-3"><i class="fas fa-circle me-1"></i> Active Now</span>
            <a asp-controller="Profile" asp-action="Index" asp-route-id="@partner.OtherId" class="btn btn-primary w-100">
                <i class="fas fa-user me-1"></i> View Profile
            </a>
        </div>
    }
}

@* --- Main Content Area --- *@
<div class="row w-100 m-0">
    <div class="col-12 p-0">
        @if (activeId == 0)
        {
            <div class="chat-container-wrapper d-flex justify-content-center align-items-center text-center">
                <div class="p-5">
                    <i class="fas fa-comments fa-3x text-muted mb-3"></i>
                    <h4 class="text-secondary">Select a person from the left to start chatting.</h4>
                </div>
            </div>
        }
        else
        {
            <div class="chat-container-wrapper" id="chatContainer">
                <div class="chat-header d-flex align-items-center">
                    <h5 class="m-0 fw-bold">Chat with @partner.OtherUsername</h5>
                </div>

                <div class="message-thread" id="messageThread">
                    @foreach (var m in thread)
                    {
                        bool mine = m.SenderId == me;
                        string bubbleClass = mine ? "mine" : "other";

                        <div class="d-flex mb-3 @(mine ? "justify-content-end" : "justify-content-start")" data-msg-id="@m.Id">

                            @if (mine)
                            {
                                <div class="message-actions dropdown">
                                    <a href="#" class="text-muted text-decoration-none dropdown-toggle" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="fas fa-ellipsis-v"></i>
                                    </a>
                                    <ul class="dropdown-menu dropdown-menu-end">
                                        <li>
                                            <form asp-action="Delete" asp-controller="Messages" method="post" class="m-0 delete-message-form">
                                                @Html.AntiForgeryToken()
                                                <input type="hidden" name="messageId" value="@m.Id" />
                                                <input type="hidden" name="otherUserId" value="@activeId" />
                                                <button type="submit" class="dropdown-item text-danger">
                                                    <i class="fas fa-trash-alt me-2"></i>Delete
                                                </button>
                                            </form>
                                        </li>
                                    </ul>
                                </div>
                            }

                            <div class="message-bubble @bubbleClass">
                                <div class="message-content mb-1">@m.Content</div>
                                <div class="small text-end @(mine ? "text-white-50" : "text-muted")">
                                    @m.SentAt.ToString("t")
                                </div>
                            </div>

                            @if (!mine)
                            {
                                @* Assuming partner details are loaded for efficiency, but using the user service call again for code completeness *@
                                var otherUser = await UserService.GetById(m.SenderId);
                                string otherAvatarUrl = string.IsNullOrWhiteSpace(otherUser?.ProfilePicture)
                                ? defaultAvatar
                                : Url.Content(otherUser.ProfilePicture);

                                <img src="@otherAvatarUrl"
                                     class="rounded-circle ms-2 align-self-end"
                                     style="width:30px;height:30px;" />
                            }
                        </div>
                    }
                    <div id="typingIndicator" class="mt-2 d-none">
                        <div class="typing-indicator"><div></div><div></div><div></div></div>
                    </div>
                </div>

                @* Send box moved OUTSIDE the scrolling area and positioned fixed via CSS *@
            </div>
        }
    </div>
</div>

@* --- Fixed Send Box (Placed outside main content for fixed positioning) --- *@
<div class="send-box-fixed @(activeId == 0 ? "d-none" : "")" id="sendBoxFixed">
    @if (activeId != 0)
    {
        <form asp-action="Send" asp-controller="Messages" method="post" class="d-flex" id="sendMessageForm">
            @Html.AntiForgeryToken()
            <input type="hidden" name="toUserId" value="@activeId" />
            <input type="text" name="content" id="messageInput"
                   class="form-control me-2"
                   placeholder="Type a message…"
                   required />
            <button class="btn btn-success" type="submit" id="sendButton">
                <i class="fas fa-paper-plane"></i> Send
            </button>
        </form>
    }
</div>


@section Scripts {
    <script>
        const myUserId = @me;
        const activeId = @activeId;
        const messageThread = document.getElementById('messageThread');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const sendMessageForm = document.getElementById('sendMessageForm');

        // Function to scroll to the bottom
        function scrollToBottom() {
            if (messageThread) {
                 messageThread.scrollTop = messageThread.scrollHeight;
            }
        }

        // Auto-scroll on load
        window.onload = scrollToBottom;

        // --- 🔑 FIX: AJAX Submission to avoid page reload (Asynchronous communication) 🔑 ---

        sendMessageForm?.addEventListener('submit', function(e) {
            e.preventDefault(); // STOP the default page reload

            const content = messageInput.value.trim();
            if (!content) return;

            // Prepare button/input for sending state
            sendButton.disabled = true;
            const originalButtonContent = sendButton.innerHTML;
            sendButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Sending...';

            // 1. Create a FormData object from the form
            const formData = new FormData(this);

            // 2. Perform the AJAX request (Fetch API)
            fetch(this.action, {
                method: 'POST',
                body: formData
            }).then(response => {
                // If the controller successfully accepted the message
                if (response.ok) {
                    // Assuming the controller returns the saved message data (e.g., as JSON)
                    // or a simple success status. For this example, we assume success
                    // and construct the message client-side.

                    // This is the CRITICAL STEP: Add the new message to the DOM instantly
                    appendMessageToThread(content, new Date());

                    messageInput.value = ''; // Clear input field
                } else {
                    alert('Error sending message. Status: ' + response.status);
                }
            }).catch(error => {
                console.error('Network or server error:', error);
                alert('A network error occurred while sending the message.');
            }).finally(() => {
                // Restore button state
                sendButton.disabled = messageInput.value.trim() === '';
                sendButton.innerHTML = originalButtonContent;
                messageInput.focus(); // Keep focus on input
            });
        });

        // Function to render a new message dynamically
        function appendMessageToThread(content, sentAt) {
            const container = document.createElement('div');
            container.className = 'd-flex mb-3 justify-content-end';

            // Format time (using simple JS formatting, adjust as needed)
            const timeText = sentAt.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            container.innerHTML = `
                <div class="message-actions dropdown">
                    <a href="#" class="text-muted text-decoration-none dropdown-toggle" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                         <i class="fas fa-ellipsis-v"></i>
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li>
                            <form class="m-0 delete-message-form">
                                <input type="hidden" name="messageId" value="temp" />
                                <input type="hidden" name="otherUserId" value="${activeId}" />
                                <button type="submit" class="dropdown-item text-danger">
                                    <i class="fas fa-trash-alt me-2"></i>Delete
                                </button>
                            </form>
                        </li>
                    </ul>
                </div>
                <div class="message-bubble mine">
                    <div class="message-content mb-1">${content}</div>
                    <div class="small text-end text-white-50">${timeText}</div>
                </div>
            `;

            messageThread.appendChild(container);
            scrollToBottom();
        }

        // Ensure button is disabled if input is empty
        messageInput?.addEventListener('input', function() {
            sendButton.disabled = this.value.trim() === '';
            // Additional logic for SignalR/Typing indicator would go here
        });

        // Initialize button state
        sendButton.disabled = messageInput.value.trim() === '';

    </script>
}