@using UrDoggy.Core.Models
@model List<UrDoggy.Core.Models.Post>
@inject UrDoggy.Services.Interfaces.IPostService PostService
@inject UrDoggy.Services.Interfaces.IUserService UserService

@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    // NOTE: C# logic remains unchanged
    int? sessionUserId = Context.Session.GetInt32("UserId");
    var currentUser = sessionUserId.HasValue
        ? await UserService.GetById(sessionUserId.Value)
        : null;
    string currentUserAvatarUrl = string.IsNullOrWhiteSpace(currentUser?.ProfilePicture)
        ? Url.Content("~/images/default-avatar.png")
        : Url.Content(currentUser.ProfilePicture);
    List<User> TaggedUsers = new List<User>();


    <link rel="stylesheet" href="~/css/layout.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
}

<style>
    /* NOTE: Design Tokens should ideally be in layout.css or a dedicated theme file */
    :root {
        --color-accent: #00b894; /* Replaced primary-color */
        --color-hover: #55efc4; /* Replaced hover-color */
        --color-text-dark: #2d3436; /* Replaced text-dark */
        /* Use card color for a soft glass effect, or a dedicated bg-glass if desired */
        --bg-glass: rgba(255, 255, 255, 0.9);
        --shadow-soft: 0 6px 20px rgba(0, 0, 0, 0.08); /* Replaced shadow-soft, slightly less harsh */
        --border-light: 1px solid rgba(0, 0, 0, 0.05);
    }

    ::-webkit-scrollbar {
        display: none;
    }

    /* --- Post Create Section (Glassmorphism inspired, now uses card-ui base) --- */
    .post-create {
        /* Use card-ui base styles, then override for glass look */
        background: var(--bg-glass);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        box-shadow: var(--shadow-soft);
        border: 1px solid rgba(255, 255, 255, 0.6); /* Lighter border */
        margin-bottom: 2rem;
        padding: 1.5rem; /* Ensure padding is consistent */
        border-radius: var(--radius); /* Use global radius */
    }

        .post-create textarea {
            background: #f1f2f6;
            border: none;
            resize: none;
            font-size: 1rem;
            padding: 1rem;
            border-radius: var(--radius);
            transition: all 0.3s ease;
            border: 1px solid transparent; /* Prepare for focus border */
        }

            .post-create textarea:focus {
                background: #fff;
                box-shadow: 0 0 0 3px rgba(37, 211, 102, 0.2); /* Use a shade of the theme color */
                outline: none;
                border-color: #25D366; /* Match theme gradient start color */
            }

        .post-create .btn-post {
            /* Use theme color from layout.css */
            background: linear-gradient(135deg, #25D366 0%, #0984e3 100%);
            color: white;
            border: none;
            padding: 0.6rem 2.2rem; /* Slightly larger/more prominent */
            border-radius: 2rem;
            font-weight: 600;
            transition: transform 0.2s, opacity 0.2s;
            line-height: 1;
        }

            .post-create .btn-post:hover {
                transform: translateY(-2px);
                opacity: 0.9;
            }

    /* --- Post Card Design --- */
    .post-card {
        /* Use card-ui base for background/shadow, then enhance */
        border-radius: var(--radius);
        box-shadow: var(--shadow-soft);
        background: var(--color-card);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        overflow: hidden;
        border: var(--border-light);
    }

        .post-card:hover {
            transform: translateY(-2px); /* Less aggressive lift */
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
        }

    /* Header of Post */
    .post-header {
        padding: 1.25rem 1.5rem 0.75rem 1.5rem; /* Better vertical spacing */
    }

    .user-avatar-sm {
        width: 48px; /* Slightly larger avatar */
        height: 48px;
        object-fit: cover;
        border: 3px solid #f1f2f6; /* Lighter border for contrast */
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        transition: transform 0.3s ease;
    }

    .post-card:hover .user-avatar-sm {
        transform: scale(1.05);
    }


    .user-name {
        font-weight: 700;
        color: var(--color-text-dark);
        text-decoration: none;
        font-size: 1.05rem;
    }

    .post-meta {
        font-size: 0.8rem;
        color: #95a5a6; /* Softer gray */
    }

    /* Post Content */
    .post-content {
        padding: 0 1.5rem 1rem 1.5rem;
        color: var(--color-text-dark);
        font-size: 1rem;
        line-height: 1.6;
    }

        .post-content p {
            margin-bottom: 0; /* Remove default margin for cleaner look */
        }

    .media-container {
        margin-top: 15px;
        border-radius: 1rem;
        overflow: hidden;
        box-shadow: var(--shadow-soft);
    }

    /* Action Bar (Like, Share...) */
    .action-bar {
        padding: 0.5rem 1.5rem;
        border-top: 1px solid #f1f2f6;
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
    }

    .btn-action {
        border-radius: 2rem;
        padding: 0.5rem 1rem;
        font-size: 0.9rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 6px;
        transition: all 0.2s;
        border: 1px solid transparent;
    }

        .btn-action:hover {
            transform: scale(1.02);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .btn-action.btn-outline-success {
            color: #25D366;
            border-color: #25D36640;
        }

            .btn-action.btn-outline-success:hover {
                background-color: #25D36610;
            }

    /* --- Comment Section --- */
    .comment-section {
        background: #fcfcfc; /* Very light background for distinction */
        padding: 1rem 1.5rem;
        border-top: var(--border-light);
    }

    .comment-box {
        background: #e9ecef; /* Light gray bubble background */
        border-radius: 1.25rem; /* Rounded comment bubble */
        padding: 0.7rem 1rem;
        border: none;
        font-size: 0.95rem;
        line-height: 1.4;
    }

    .comment-input-area textarea {
        border-radius: 1.5rem;
        background: #fff;
        border: 1px solid #ddd;
        padding: 0.7rem 1.2rem;
        font-size: 0.9rem;
        min-height: 38px;
        transition: border-color 0.2s;
    }

        .comment-input-area textarea:focus {
            border-color: #0984e3; /* Theme accent on focus */
            box-shadow: none;
        }

    .comment-input-area .btn {
        line-height: 1.1;
    }

    /* Avatar size for comments */
    .commenter-avatar {
        width: 32px;
        height: 32px;
        min-width: 32px;
    }

    /* Responsive adjustments for mobile */
    @@media (max-width: 768px) {
        .post-create, .post-card {
            border-radius: 0;
            box-shadow: none;
            margin-bottom: 1rem;
            border-left: none;
            border-right: none;
        }

        .post-header, .post-content, .action-bar, .comment-section {
            padding-left: 1rem;
            padding-right: 1rem;
        }
    }
</style>

@section LeftSidebar {
    <partial name="~/Views/Shared/Partials/LeftSidebar/_LeftSidebar.cshtml" />
}

@section RightSidebar {
    <partial name="~/Views/Shared/Partials/RightSidebar/_RightSidebar.cshtml" />
}

@* --- Post Creation Component --- *@
<div class="post-create rounded-ui">
    <form method="post" asp-action="Create" enctype="multipart/form-data">
        @Html.AntiForgeryToken()
        <div class="d-flex align-items-start">
            <img src="@currentUserAvatarUrl" class="rounded-circle me-3 shadow-sm" style="width:50px;height:50px; object-fit: cover;" alt="Your Avatar" />

            <div class="flex-grow-1 position-relative">
                <textarea name="content"
                          id="postContent"
                          class="form-control"
                          rows="3"
                          placeholder="What's on your mind, @(currentUser?.UserName ?? "friend")?"
                          required></textarea>

                @* Tag Popups (Logic retained) *@
                <div id="tag-popup"
                     style="position: absolute; display: none; width: 250px; z-index: 9999; top: 100%;">
                </div>
                <div id="hashtagSuggestions"
                     class="position-absolute d-none end-0 start-0 mt-1 rounded border bg-white shadow-lg"
                     style="z-index: 1000; max-height: 300px; overflow-y: auto; top: 100%;">
                </div>
            </div>
        </div>

        <div class="d-flex justify-content-between align-items-center border-top border-light mt-3 pt-3">
            <div class="flex-grow-1 me-3">
                <input type="file" name="mediaFiles" multiple accept="image/*,video/*" class="form-control form-control-sm" style="border-radius: 1rem;" />
            </div>
            <button type="submit" class="btn-post shadow-sm">Post</button>
        </div>
    </form>
</div>

@* --- Post Feed Component --- *@
@foreach (var post in Model)
{
    bool isOwnPost = sessionUserId.HasValue && sessionUserId.Value == post.UserId;
    string editPostDivId = "edit-post-" + post.Id;
    var postAuthor = await UserService.GetById(post.UserId);
    string postAuthorAvatarUrl = string.IsNullOrWhiteSpace(postAuthor?.ProfilePicture)
        ? Url.Content("~/images/default-avatar.png")
        : Url.Content(postAuthor.ProfilePicture);

    <div class="post-card mb-4">

        <div class="post-header d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
                <img src="@postAuthorAvatarUrl" class="rounded-circle user-avatar-sm" alt="@(postAuthor?.UserName) Avatar" />
                <div class="ms-3">
                    <a asp-controller="Profile" asp-action="Index" asp-route-id="@post.UserId" class="user-name">
                        @(postAuthor?.UserName ?? "Unknown User")
                    </a>
                    <div class="post-meta">@post.CreatedAt:g</div>
                </div>
            </div>

            @if (isOwnPost)
            {
                <div class="dropdown">
                    <button class="btn btn-sm btn-light rounded-circle" type="button" data-bs-toggle="dropdown" aria-expanded="false" title="Post Options">
                        <i class="bi bi-three-dots"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end border-0 shadow">
                        <li>
                            <button class="dropdown-item d-flex align-items-center" onclick="startPostEdit(@post.Id)">
                                <i class="bi bi-pencil me-2"></i> Edit
                            </button>
                        </li>
                        <li>
                            <form asp-controller="Newsfeed" asp-action="Delete" method="post" onsubmit="return confirm('Are you sure you want to delete this post?');">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="postId" value="@post.Id" />
                                <button class="dropdown-item text-danger d-flex align-items-center">
                                    <i class="bi bi-trash me-2"></i> Delete
                                </button>
                            </form>
                        </li>
                    </ul>
                </div>
            }
        </div>

        @* Edit Form (Logic retained) *@
        <div id="@editPostDivId" class="px-4 pb-3" style="display:none;">
            <div class="card-ui bg-light border-0 p-3">
                <form method="post" asp-controller="Newsfeed" asp-action="Edit" enctype="multipart/form-data">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="postId" value="@post.Id" />
                    <label class="form-label fw-bold mb-1">Edit Post</label>
                    <textarea name="content" class="form-control rounded-ui mb-2" rows="3">@post.Content</textarea>
                    <input type="file" name="mediaFiles" multiple accept="image/*,video/*" class="form-control form-control-sm rounded-ui mb-2" />
                    <div class="d-flex justify-content-end gap-2">
                        <button type="button" class="btn btn-sm btn-secondary rounded-pill" onclick="cancelPostEdit(@post.Id)">Cancel</button>
                        <button type="submit" class="btn btn-sm btn-primary rounded-pill">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="post-content">
            <p class="mb-2">@post.Content</p>

            @if (post.MediaItems != null && post.MediaItems.Any())
            {
                <div class="media-container">
                    @foreach (var item in post.MediaItems)
                    {
                        if (item.MediaType == "image")
                        {
                            <img src="@Url.Content(item.Path)" class="img-fluid w-100" alt="Post media image" style="display:block;" />
                        }
                        else if (item.MediaType == "video")
                        {
                            <video controls class="w-100">
                                <source src="@Url.Content(item.Path)" />
                            </video>
                        }
                    }
                </div>
            }
        </div>

        @* Action Bar *@
        <div class="action-bar">
            @* <form asp-controller="Newsfeed" asp-action="Vote" method="post" class="d-inline"> *@
            @*     @Html.AntiForgeryToken() *@
            @*     <input type="hidden" name="postId" value="@post.Id" /> *@
            @*     <button name="isUpvote" value="true" class="btn btn-action btn-outline-success"> *@
            @*         <i class="bi bi-hand-thumbs-up-fill"></i> @post.UpVotes *@
            @*     </button> *@
            @* </form> *@

            @* <form asp-controller="Newsfeed" asp-action="Vote" method="post" class="d-inline"> *@
            @*     @Html.AntiForgeryToken() *@
            @*     <input type="hidden" name="postId" value="@post.Id" /> *@
            @*     <button name="isUpvote" value="false" class="btn btn-action btn-outline-danger"> *@
            @*         <i class="bi bi-hand-thumbs-down-fill"></i> @post.DownVotes *@
            @*     </button> *@
            @* </form> *@

            <div class="vote-container d-flex gap-3">
                @await Html.PartialAsync("_VoteButtons", post)
            </div>

            <button type="button" class="btn btn-action btn-outline-secondary" onclick="copyShareLink(@post.Id)">
                <i class="bi bi-share-fill"></i> Share
            </button>

            <div class="d-flex ms-auto gap-2">
                @* NOTE: I replaced Hide/Unhide with a single option in the dropdown to keep the bar cleaner, but kept the original forms here as requested to avoid logic change. You might want to hide one or the other based on post status in the view logic. *@
                <form asp-controller="Newsfeed" asp-action="Hide" method="post" class="d-inline" style="display:none !important;">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="postId" value="@post.Id" />
                    <button class="btn btn-action btn-sm btn-light text-muted">Hide</button>
                </form>
                <form asp-controller="Newsfeed" asp-action="Unhide" method="post" class="d-inline" style="display:none !important;">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="postId" value="@post.Id" />
                    <button class="btn btn-action btn-sm btn-light text-success">Unhide</button>
                </form>

                @if (!isOwnPost)
                {
                    <a asp-controller="Report" asp-action="Create" asp-route-postId="@post.Id"
                       class="btn btn-action btn-sm btn-outline-warning d-flex align-items-center">
                        <i class="bi bi-flag-fill"></i> Report
                    </a>
                }
            </div>
        </div>

        @* Comment Section *@
        <div class="comment-section">

            @* Add Comment Form *@
            <form asp-controller="Newsfeed" asp-action="AddComment" method="post" class="d-flex align-items-start comment-input-area mb-4">
                @Html.AntiForgeryToken()
                <input type="hidden" name="postId" value="@post.Id" />
                <img src="@currentUserAvatarUrl" class="rounded-circle commenter-avatar me-2" alt="Your Avatar" />
                <div class="flex-grow-1 position-relative">
                    <textarea name="content" class="form-control" rows="1" id="content-box"
                              placeholder="Write a comment..." required></textarea>

                    @* Tag Popup (Logic retained) *@
                    <div id="tag-popup"
                         style="position: absolute; display: none; width: 250px; z-index: 9999;">
                    </div>
                </div>
                <button type="submit" class="btn btn-primary btn-sm rounded-pill ms-2 mt-1 px-3">
                    <i class="bi bi-send-fill"></i>
                </button>
            </form>

            @* Existing Comments *@
            @foreach (var comment in post.Comments)
            {
                bool isOwnComment = sessionUserId.HasValue && sessionUserId.Value == comment.UserId;
                var commenter = comment.User;
                string commenterAvatarUrl = string.IsNullOrWhiteSpace(commenter?.ProfilePicture)
                ? Url.Content("~/images/default-avatar.png")
                : Url.Content(commenter.ProfilePicture);
                string editCommentDivId = "edit-comment-" + comment.Id;

                <div class="d-flex mb-3">
                    <img src="@commenterAvatarUrl" class="rounded-circle commenter-avatar" alt="@(commenter?.UserName) Avatar" />

                    <div class="w-100 ms-2">
                        <div class="comment-box d-inline-block shadow-sm">
                            <div class="d-flex align-items-baseline mb-1">
                                <a asp-controller="Profile" asp-action="Index" asp-route-id="@comment.UserId" class="text-dark text-decoration-none me-2">
                                    <strong class="text-primary" style="font-size: 0.9rem;">@comment.User.UserName</strong>
                                </a>
                                <small class="text-muted" style="font-size: 0.7rem;">@comment.CreatedAt:g</small>
                            </div>
                            <span class="text-break">@comment.Content</span>
                        </div>

                        @if (isOwnComment)
                        {
                            <div class="ms-3 mt-1">
                                <button type="button" class="btn btn-link btn-sm text-primary me-2 p-0"
                                        style="font-size: 0.8rem;"
                                        onclick="startCommentEdit(@comment.Id)">
                                    Edit
                                </button>

                                <form asp-controller="Newsfeed" asp-action="DeleteComment" method="post" class="d-inline" onsubmit="return confirm('Are you sure you want to delete this comment?');">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="commentId" value="@comment.Id" />
                                    <input type="hidden" name="postId" value="@post.Id" />
                                    <button type="submit" class="btn btn-link btn-sm text-danger p-0"
                                            style="font-size: 0.8rem;">
                                        Delete
                                    </button>
                                </form>
                            </div>
                        }

                        @* Edit Comment Form (Logic retained) *@
                        <div id="@editCommentDivId" style="display:none; margin-top:0.5rem;" class="rounded-ui border bg-white p-2 shadow-sm">
                            <form asp-controller="Newsfeed" asp-action="EditComment" method="post">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="commentId" value="@comment.Id" />
                                <input type="hidden" name="postId" value="@post.Id" />
                                <textarea name="content" class="form-control rounded-ui mb-2" rows="2" required>@comment.Content</textarea>
                                <div class="text-end">
                                    <button type="button" class="btn btn-sm btn-secondary rounded-pill me-1" onclick="cancelCommentEdit(@comment.Id)">Cancel</button>
                                    <button type="submit" class="btn btn-sm btn-primary rounded-pill">Save</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
}

@section Scripts {
    <script src="~/js/hashtag-suggestion.js"></script>
    <script src="~/js/post-tagging.js"></script>

    <script>
        function copyShareLink(postId) {
            const url = `${window.location.origin}/Newsfeed/Details/${postId}`;
            navigator.clipboard.writeText(url)
                .then(() => alert('Link copied to clipboard! 📋'))
                .catch(() => alert('Failed to copy URL'));
        }
        function startPostEdit(postId) {
            document.getElementById('edit-post-' + postId).style.display = 'block';
        }
        function cancelPostEdit(postId) {
            document.getElementById('edit-post-' + postId).style.display = 'none';
        }
        function startCommentEdit(commentId) {
            document.getElementById('edit-comment-' + commentId).style.display = 'block';
        }
        function cancelCommentEdit(commentId) {
            document.getElementById('edit-comment-' + commentId).style.display = 'none';
        }
    </script>
}